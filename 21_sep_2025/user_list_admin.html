<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶§‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;font-family:'Noto Sans Bengali',sans-serif;}
    body{margin:0;background:#f4f6f8;color:#333;padding:20px;}
    h2{text-align:center;color:#d32f2f;margin-bottom:20px;font-size:28px;}

    /* Filters */
    .filters{
        display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:15px;
    }
    .filters select{
        padding:6px 10px;border:1px solid #ccc;border-radius:6px;
        font-size:14px;min-width:120px;background:#fff;
    }
    .filters select:focus{border-color:#d32f2f;outline:none;}

    /* Count + selection toggle */
    .topbar{
        display:flex;justify-content:space-between;align-items:center;
        margin-bottom:15px;flex-wrap:wrap;gap:10px;
    }
    .count{font-weight:600;color:#444;}
    .selection-actions{display:none;gap:10px;align-items:center;}
    .selection-actions button,.toggle-select-btn{
        background:#d32f2f;color:#fff;border:none;padding:8px 14px;
        border-radius:6px;font-size:14px;cursor:pointer;transition:background 0.3s;
    }
    .selection-actions button:hover,.toggle-select-btn:hover{background:#b71c1c;}
    .selection-actions button:disabled{background:#ccc;cursor:not-allowed;}

    /* Table */
    .table-container{overflow-x:auto;}
    table{
        width:100%;border-collapse:collapse;background:#fff;
        border-radius:12px;overflow:hidden;box-shadow:0 3px 10px rgba(0,0,0,0.1);
    }
    th,td{padding:12px 15px;text-align:left;font-size:15px;}
    th{background:#d32f2f;color:#fff;}
    tr:nth-child(even){background:#f9f9f9;}
    tr:hover{background:#ffe6e6;}
    .view-btn{
        background:#1976d2;color:#fff;padding:6px 12px;border:none;
        border-radius:4px;cursor:pointer;font-size:14px;transition:background 0.3s;
    }
    .view-btn:hover{background:#0d47a1;}
    @media(max-width:700px){th,td{font-size:14px;padding:10px;}}

    /* Modal */
    .modal{
        display:none;position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:1000;
    }
    .modal-content{
        background:#fff;padding:20px;border-radius:10px;
        max-width:400px;width:90%;text-align:center;
    }
    .modal-content h3{margin-top:0;color:#d32f2f;}
    .modal-content p{margin:8px 0;}
    .close-modal,
    .call-btn{
        background:#d32f2f;color:#fff;padding:8px 14px;border:none;
        border-radius:6px;cursor:pointer;margin-top:10px;font-size:15px;
        display:inline-block;
        text-decoration:none;transition:background 0.3s;
    }
    .close-modal:hover,.call-btn:hover{background:#b71c1c;}
    .call-btn{background:#28a745;}
    .call-btn:hover{background:#1e7e34;}

    /* Notification Modal */
    .notification-modal .modal-content {
        max-width: 500px;
    }
    .notification-modal textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        resize: vertical;
        font-size: 14px;
        margin-bottom: 15px;
        font-family: 'Noto Sans Bengali', sans-serif;
    }
    .notification-modal .notification-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
    }
    .notification-modal .notification-options label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    .notification-modal .notification-options input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
    .notification-modal .send-notification-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: background 0.3s;
    }
    .notification-modal .send-notification-btn:hover {
        background: #388e3c;
    }
    .notification-modal .send-notification-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Permission Section */
    .permission-section {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #2196f3;
        display: none;
    }
    .permission-section h3 {
        margin-top: 0;
        color: #1976d2;
    }
    .permission-btn {
        background: #2196f3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }

    /* Toast Notification */
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        padding: 15px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1100;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 350px;
        transform: translateY(100px);
        opacity: 0;
        transition: transform 0.3s, opacity 0.3s;
    }
    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    .toast.error {
        background: #f44336;
    }
    .toast.info {
        background: #2196f3;
    }
    .toast .close-toast {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        margin-left: auto;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .topbar {
            flex-direction: column;
            align-items: flex-start;
        }
        .selection-actions {
            width: 100%;
            justify-content: space-between;
        }
        .toast {
            left: 20px;
            right: 20px;
            max-width: none;
        }
    }
  </style>
</head>
<body>

  <h2>‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶§‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>

  <!-- Notification Permission Section -->
  <div class="permission-section" id="permissionSection">
    <h3>‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®</h3>
    <p>‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡ßá‡¶§‡ßá ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡¶ø‡¶®‡•§</p>
    <button class="permission-btn" id="requestPermission">‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡¶ø‡¶®</button>
    <span id="permissionStatus"></span>
  </div>

  <div class="filters">
      <select id="filterJela"><option value="">‡¶ú‡ßá‡¶≤‡¶æ</option></select>
      <select id="filterUpojela" disabled><option value="">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</option></select>
      <select id="filterBlood">
          <option value="">‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™</option>
          <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
          <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
      </select>
  </div>

  <div class="topbar">
      <div class="count">‡¶Æ‡ßã‡¶ü: <span id="userCount">0</span></div>
      <button class="toggle-select-btn">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßã‡¶° ‡¶ö‡¶æ‡¶≤‡ßÅ</button>
      <div class="selection-actions">
          <button id="deleteSelected">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
          <button id="openNotificationModal">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§‡¶ï‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
      </div>
  </div>

  <div class="table-container">
  <table id="userTable">
      <thead>
          <tr>
              <th class="select-col" style="display:none;"><input type="checkbox" id="selectAll"></th>
              <th>‡¶®‡¶æ‡¶Æ</th>
              <th>‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™</th>
              <th>‡¶´‡ßã‡¶®</th>
              <th>‡¶∂‡ßá‡¶∑ ‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶®</th>
              <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
          </tr>
      </thead>
      <tbody></tbody>
  </table>
  </div>

  <!-- User Detail Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <h3>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶•‡ßç‡¶Ø</h3>
      <div id="modalBody"></div>
      <a id="callBtn" class="call-btn" href="#" target="_blank">‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</a><br>
      <button class="close-modal">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>

  <!-- Notification Modal -->
  <div class="modal notification-modal" id="notificationModal">
    <div class="modal-content">
      <h3>‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®</h3>
      <p id="notificationRecipients">‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï: ‡ß¶ ‡¶ú‡¶®</p>
      <textarea id="notificationMessage" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
      <div class="notification-options">
        <label>
          <input type="checkbox" id="sendBrowserNotification" checked>
          ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®
          <span id="browserNotificationStatus" style="font-size:12px;color:#666;"></span>
        </label>
        <label>
          <input type="checkbox" id="sendPushNotification">
          ‡¶™‡ßÅ‡¶∂ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶•‡¶æ‡¶ï‡ßá)
        </label>
      </div>
      <button id="sendNotificationBtn" class="send-notification-btn">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
      <button class="close-modal">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span id="toastMessage"></span>
    <button class="close-toast">&times;</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAqhLfmOfmP-_8DOcoEH7Ck7fMF9Id4vJ4",
      authDomain: "earn-project-5f892.firebaseapp.com",
      databaseURL: "https://earn-project-5f892-default-rtdb.firebaseio.com/",
      projectId: "earn-project-5f892",
      storageBucket: "earn-project-5f892.firebasestorage.app",
      messagingSenderId: "8457886057",
      appId: "1:8457886057:web:b5e01d0972d169f47085f8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const filterJela = document.getElementById('filterJela');
    const filterUpojela = document.getElementById('filterUpojela');
    const filterBlood = document.getElementById('filterBlood');
    const userTableBody = document.querySelector('#userTable tbody');
    const userCount = document.getElementById('userCount');
    const modal = document.getElementById('userModal');
    const modalBody = document.getElementById('modalBody');
    const callBtn = document.getElementById('callBtn');
    const closeModalBtn = document.querySelectorAll('.close-modal');

    const toggleSelectBtn = document.querySelector('.toggle-select-btn');
    const selectionActions = document.querySelector('.selection-actions');
    const selectAllChk = document.getElementById('selectAll');
    const deleteSelectedBtn = document.getElementById('deleteSelected');
    const openNotificationModalBtn = document.getElementById('openNotificationModal');

    const notificationModal = document.getElementById('notificationModal');
    const notificationRecipients = document.getElementById('notificationRecipients');
    const notificationMessage = document.getElementById('notificationMessage');
    const sendBrowserNotification = document.getElementById('sendBrowserNotification');
    const sendPushNotification = document.getElementById('sendPushNotification');
    const sendNotificationBtn = document.getElementById('sendNotificationBtn');
    const browserNotificationStatus = document.getElementById('browserNotificationStatus');

    const permissionSection = document.getElementById('permissionSection');
    const requestPermissionBtn = document.getElementById('requestPermission');
    const permissionStatus = document.getElementById('permissionStatus');

    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const closeToastBtn = document.querySelector('.close-toast');

    let donors = [];
    let filtered = [];
    let jelaUpojelaMap = {};
    let selectionMode = false;
    let selectedUsers = new Set();

    // Check if browser supports notifications
    const notificationSupported = 'Notification' in window;

    // Update permission status display
    function updatePermissionStatus() {
      if (!notificationSupported) {
        browserNotificationStatus.textContent = '(‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ)';
        sendBrowserNotification.disabled = true;
        permissionSection.style.display = 'block';
        permissionStatus.innerHTML = '<span style="color:red">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ</span>';
        return;
      }

      switch(Notification.permission) {
        case 'granted':
          browserNotificationStatus.textContent = '(‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ü‡¶õ‡ßá)';
          sendBrowserNotification.disabled = false;
          permissionSection.style.display = 'none';
          break;
        case 'denied':
          browserNotificationStatus.textContent = '(‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá)';
          sendBrowserNotification.disabled = true;
          permissionSection.style.display = 'block';
          permissionStatus.innerHTML = '<span style="color:red">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶®‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</span>';
          break;
        case 'default':
          browserNotificationStatus.textContent = '(‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®)';
          sendBrowserNotification.disabled = false;
          permissionSection.style.display = 'block';
          permissionStatus.innerHTML = '<span style="color:orange">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡¶ø‡¶®</span>';
          break;
      }
    }

    // Request notification permission
    function requestNotificationPermission() {
      if (!notificationSupported) {
        showToast('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ', true);
        return;
      }

      Notification.requestPermission().then(permission => {
        updatePermissionStatus();
        if (permission === 'granted') {
          showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', false);
          // Show a test notification
          sendBrowserNotificationFunc('‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶§‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ', '‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá!');
        } else if (permission === 'denied') {
          showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', true);
        }
      });
    }

    // Show toast notification
    function showToast(message, isError = false, isInfo = false) {
      toastMessage.textContent = message;
      toast.className = 'toast' + (isError ? ' error' : (isInfo ? ' info' : ''));
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Close toast
    closeToastBtn.addEventListener('click', () => {
      toast.classList.remove('show');
    });

    // Send browser notification
    function sendBrowserNotificationFunc(title, message) {
    if (!('Notification' in window)) {
        showToast('‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ', true);
        return false;
    }
    
    if (Notification.permission === 'granted') {
        // ‚úÖ Service Worker ‡¶¶‡¶ø‡ßü‡ßá ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        if (window.swRegistration && window.swRegistration.showNotification) {
            window.swRegistration.showNotification(title, {
                body: message,
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ü©∏</text></svg>',
                badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ü©∏</text></svg>',
                vibrate: [200, 100, 200], // optional
            });
            return true;
        } else {
            console.error('ServiceWorkerRegistration.showNotification() not available');
            showToast('Service worker ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø', true);
            return false;
        }
    } else if (Notification.permission === 'default') {
        showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡¶ø‡¶®', true);
        requestNotificationPermission();
        return false;
    } else {
        showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá', true);
        return false;
    }
}

    function updateJelaOptions(){
        filterJela.innerHTML = '<option value="">‡¶ú‡ßá‡¶≤‡¶æ</option>';
        Object.keys(jelaUpojelaMap).sort().forEach(j=>{
            let o = document.createElement('option');
            o.value = j; o.textContent = j;
            filterJela.appendChild(o);
        });
    }

    function daysSince(dateStr){
        if(!dateStr) return '‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á';
        const diff = Date.now() - new Date(dateStr).getTime();
        if(isNaN(diff)) return '‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á';
        return Math.floor(diff/(1000*60*60*24)); // ‡¶¶‡¶ø‡¶®
    }

    function applyFilter(){
        const j = filterJela.value;
        const u = filterUpojela.value;
        const b = filterBlood.value;
        filtered = donors.filter(d =>
            (!j || d.district===j) &&
            (!u || d.upazila===u) &&
            (!b || d.bloodGroup===b)
        );
        renderTable();
        userCount.textContent = filtered.length;
    }

    function renderTable(){
        userTableBody.innerHTML = '';
        if(filtered.length===0){
            userTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á</td></tr>';
            return;
        }
        filtered.forEach(d=>{
            const tr = document.createElement('tr');
            const lastDonateDays = daysSince(d.lastDonateDate);
            const isSelected = selectedUsers.has(d.id);
            
            if(selectionMode){
                tr.innerHTML = `
                    <td class="select-col"><input type="checkbox" class="rowSelect" data-id="${d.id}" ${isSelected ? 'checked' : ''}></td>
                    <td>${d.fullname||''}</td>
                    <td>${d.bloodGroup||''}</td>
                    <td>${d.phone||''}</td>
                    <td>${lastDonateDays}</td>
                    <td><button class="view-btn" data-id="${d.id}">View</button></td>
                `;
            } else {
                tr.innerHTML = `
                    <td style="display:none;"></td>
                    <td>${d.fullname||''}</td>
                    <td>${d.bloodGroup||''}</td>
                    <td>${d.phone||''}</td>
                    <td>${lastDonateDays}</td>
                    <td><button class="view-btn" data-id="${d.id}">View</button></td>
                `;
            }
            userTableBody.appendChild(tr);
        });
        
        // Update notification button state
        openNotificationModalBtn.disabled = selectedUsers.size === 0;
    }

    userTableBody.addEventListener('click',e=>{
        if(e.target.classList.contains('view-btn')){
            const id = e.target.dataset.id;
            const d = donors.find(x=>x.id===id);
            modalBody.innerHTML = `
                <p><b>‡¶®‡¶æ‡¶Æ:</b> ${d.fullname||''}</p>
                <p><b>‡¶¨‡¶Ø‡¶º‡¶∏:</b> ${d.age||''}</p>
                <p><b>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó:</b> ${d.division||''}</p>
                <p><b>‡¶ú‡ßá‡¶≤‡¶æ:</b> ${d.district||''}</p>
                <p><b>‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ:</b> ${d.upazila||''}</p>
                <p><b>‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™:</b> ${d.bloodGroup||''}</p>
                <p><b>‡¶´‡ßã‡¶®:</b> ${d.phone||''}</p>
                <p><b>‡¶á‡¶Æ‡ßá‡¶á‡¶≤:</b> ${d.email||''}</p>
                <p><b>‡¶∂‡ßá‡¶∑ ‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡¶ø‡¶®:</b> ${daysSince(d.lastDonateDate)}</p>
            `;
            callBtn.href = `tel:${d.phone||''}`;
            modal.style.display='flex';
        }
    });
    
    // Close modals
    closeModalBtn.forEach(btn => {
      btn.onclick = () => {
        modal.style.display = 'none';
        notificationModal.style.display = 'none';
      };
    });
    
    window.onclick = e => {
      if(e.target === modal || e.target === notificationModal) {
        modal.style.display = 'none';
        notificationModal.style.display = 'none';
      }
    };

    filterJela.addEventListener('change',()=>{
        filterUpojela.innerHTML='<option value="">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</option>';
        const j = filterJela.value;
        if(j && jelaUpojelaMap[j]){
            filterUpojela.disabled=false;
            [...jelaUpojelaMap[j]].sort().forEach(u=>{
                const o = document.createElement('option');
                o.value=u; o.textContent=u;
                filterUpojela.appendChild(o);
            });
        } else {filterUpojela.disabled=true;}
        applyFilter();
    });
    filterUpojela.addEventListener('change',applyFilter);
    filterBlood.addEventListener('change',applyFilter);

    // Selection mode toggle
    toggleSelectBtn.addEventListener('click',()=>{
        selectionMode = !selectionMode;
        document.querySelector('th.select-col').style.display = selectionMode ? '' : 'none';
        selectAllChk.checked = false;
        selectionActions.style.display = selectionMode ? 'flex' : 'none';
        toggleSelectBtn.textContent = selectionMode ? '‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßã‡¶° ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßã‡¶° ‡¶ö‡¶æ‡¶≤‡ßÅ';
        
        // Clear selection when turning off selection mode
        if (!selectionMode) {
          selectedUsers.clear();
        }
        
        renderTable();
    });
    
    // Select all checkbox
    selectAllChk.addEventListener('change',()=>{
        const checkboxes = document.querySelectorAll('.rowSelect');
        checkboxes.forEach(c => {
          c.checked = selectAllChk.checked;
          if (selectAllChk.checked) {
            selectedUsers.add(c.dataset.id);
          } else {
            selectedUsers.delete(c.dataset.id);
          }
        });
        openNotificationModalBtn.disabled = selectedUsers.size === 0;
        notificationRecipients.textContent = `‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï: ${selectedUsers.size} ‡¶ú‡¶®`;
    });
    
    // Individual row selection
    userTableBody.addEventListener('change', e => {
      if (e.target.classList.contains('rowSelect')) {
        const id = e.target.dataset.id;
        if (e.target.checked) {
          selectedUsers.add(id);
        } else {
          selectedUsers.delete(id);
          selectAllChk.checked = false;
        }
        openNotificationModalBtn.disabled = selectedUsers.size === 0;
        notificationRecipients.textContent = `‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï: ${selectedUsers.size} ‡¶ú‡¶®`;
      }
    });

    // Delete selected users
    deleteSelectedBtn.addEventListener('click',()=>{
        const ids = [...selectedUsers];
        if(ids.length && confirm('‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?')){
            ids.forEach(id=>db.ref('donors/'+id).remove());
            selectedUsers.clear();
            selectAllChk.checked = false;
            showToast(`${ids.length} ‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
        }
    });
    
    // Open notification modal
    openNotificationModalBtn.addEventListener('click', () => {
      if (selectedUsers.size === 0) {
        showToast('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', true);
        return;
      }
      
      notificationRecipients.textContent = `‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï: ${selectedUsers.size} ‡¶ú‡¶®`;
      notificationMessage.value = '';
      updatePermissionStatus(); // Update status before showing modal
      notificationModal.style.display = 'flex';
    });
    
    // Send notification
    sendNotificationBtn.addEventListener('click', () => {
      const message = notificationMessage.value.trim();
      if (!message) {
        showToast('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®', true);
        return;
      }
      
      const sendBrowser = sendBrowserNotification.checked;
      const sendPush = sendPushNotification.checked;
      
      // Save notification to database
      const notificationData = {
        message: message,
        recipients: [...selectedUsers],
        timestamp: Date.now(),
        sendBrowser: sendBrowser,
        sendPush: sendPush
      };
      
      db.ref('notifications').push(notificationData)
        .then(() => {
          let notificationSent = false;
          
          // Show browser notification if requested
          if (sendBrowser) {
            notificationSent = sendBrowserNotificationFunc('‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶§‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ', message);
          }
          
          if (notificationSent) {
            showToast(`‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ${selectedUsers.size} ‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`);
          } else if (sendBrowser) {
            showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', true);
          } else {
            showToast(`‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ${selectedUsers.size} ‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`);
          }
          
          notificationModal.style.display = 'none';
        })
        .catch(error => {
          console.error('Error sending notification:', error);
          showToast('‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', true);
        });
    });

    // Test notification button (for debugging)
    const testNotificationBtn = document.createElement('button');
    testNotificationBtn.textContent = '‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®';
    testNotificationBtn.style.position = 'fixed';
    testNotificationBtn.style.top = '10px';
    testNotificationBtn.style.right = '10px';
    testNotificationBtn.style.zIndex = '1000';
    testNotificationBtn.style.padding = '5px 10px';
    testNotificationBtn.style.background = '#ff9800';
    testNotificationBtn.style.color = 'white';
    testNotificationBtn.style.border = 'none';
    testNotificationBtn.style.borderRadius = '4px';
    testNotificationBtn.style.cursor = 'pointer';
    testNotificationBtn.addEventListener('click', () => {
      sendBrowserNotificationFunc('‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®', '‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®!');
    });
    document.body.appendChild(testNotificationBtn);
  </script>
  <script>
      if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
        console.log('Service worker registered', reg);
        window.swRegistration = reg; // ‡¶™‡¶∞‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
    }).catch(err => console.error('SW registration failed:', err));
}
  </script>
  <script>
    db.ref('donors').on('value', snapshot => {
        donors = [];
        snapshot.forEach(child => {
            donors.push({
                id: child.key,
                ...child.val()
            });
        });
        
        // Upazila list ‡¶§‡ßà‡¶∞‡¶ø
        jelaUpojelaMap = {};
        donors.forEach(d => {
            if (!jelaUpojelaMap[d.district]) jelaUpojelaMap[d.district] = new Set();
            jelaUpojelaMap[d.district].add(d.upazila);
        });
        
        updateJelaOptions(); // ‡¶ú‡ßá‡¶≤‡¶æ dropdown ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
        filtered = donors; // ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        userCount.textContent = donors.length;
        renderTable(); // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
    });
</script>
</body>
</html>