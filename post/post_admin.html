<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Create Post</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Roboto', sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
    }
    header {
        background-color: #dc3545;
        color: white;
        padding: 1rem;
        text-align: center;
    }
    .container {
        max-width: 500px;
        margin: 2rem auto;
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    input, textarea, button, select {
        width: 100%;
        padding: 0.8rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 1rem;
    }
    button {
        background-color: #dc3545;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover {
        background-color: #c82333;
    }
</style>
</head>
<body>
<header>
    <h1>Create Post</h1>
</header>

<div class="container">
    <label for="authorSelect">Select Author</label>
    <select id="authorSelect">
        <option value="">-- New Author --</option>
    </select>
    <input type="text" id="userName" placeholder="Author Name (if new)">
    <input type="file" id="userProfileFile" accept="image/*">
    
    <textarea id="description" rows="4" placeholder="Post Description"></textarea>
    <input type="file" id="postImageFile" accept="image/*">
    <button id="submitPost">Submit Post</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAqhLfmOfmP-_8DOcoEH7Ck7fMF9Id4vJ4",
    authDomain: "earn-project-5f892.firebaseapp.com",
    databaseURL: "https://earn-project-5f892-default-rtdb.firebaseio.com/",
    projectId: "earn-project-5f892",
    storageBucket: "earn-project-5f892.firebasestorage.app",
    messagingSenderId: "8457886057",
    appId: "1:8457886057:web:b5e01d0972d169f47085f8"
  };

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Cloudinary config
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dhvtgzy5x/upload";
const CLOUDINARY_UPLOAD_PRESET = "Rosenews";

const authorSelect = document.getElementById("authorSelect");
const userNameInput = document.getElementById("userName");
const userProfileFile = document.getElementById("userProfileFile");
const descriptionInput = document.getElementById("description");
const postImageFile = document.getElementById("postImageFile");
const submitPostBtn = document.getElementById("submitPost");

// Load authors
async function loadAuthors() {
    const snapshot = await getDocs(collection(db, "authors"));
    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = data.name;
        option.dataset.profile = data.profile || "";
        authorSelect.appendChild(option);
    });
}
loadAuthors();

// Author selection change
authorSelect.addEventListener("change", () => {
    const selected = authorSelect.selectedOptions[0];
    if(selected.value) {
        userNameInput.value = selected.textContent;
    } else {
        userNameInput.value = "";
    }
});

// Upload image to Cloudinary
async function uploadToCloudinary(file) {
    if(!file) return "";
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
    
    const res = await fetch(CLOUDINARY_URL, {
        method: "POST",
        body: formData
    });
    const data = await res.json();
    return data.secure_url;
}

// Submit Post
submitPostBtn.addEventListener("click", async () => {
    const userName = userNameInput.value.trim();
    if(!userName) return alert("Author name is required");
    
    // Check if author already exists
    let authorId = authorSelect.value;
    let authorProfileUrl = "";

    if(authorId) {
        authorProfileUrl = authorSelect.selectedOptions[0].dataset.profile;
    } else {
        // Upload author image
        const file = userProfileFile.files[0];
        authorProfileUrl = await uploadToCloudinary(file);
        // Save author in Firestore
        const newAuthorRef = doc(collection(db, "authors"));
        await setDoc(newAuthorRef, {
            name: userName,
            profile: authorProfileUrl
        });
        authorId = newAuthorRef.id;

        // Add to dropdown
        const option = document.createElement("option");
        option.value = authorId;
        option.textContent = userName;
        option.dataset.profile = authorProfileUrl;
        authorSelect.appendChild(option);
        authorSelect.value = authorId;
    }

    // Upload post image
    const postFile = postImageFile.files[0];
    const postImageUrl = await uploadToCloudinary(postFile);

    // Save post
    await addDoc(collection(db, "posts"), {
        userName,
        userProfile: authorProfileUrl,
        description: descriptionInput.value.trim(),
        postImage: postImageUrl || "",
        timestamp: serverTimestamp()
    });

    alert("Post submitted successfully!");
    descriptionInput.value = "";
    postImageFile.value = "";
    userProfileFile.value = "";
});
</script>
</body>
</html>